// Generated by CoffeeScript 1.4.0
(function(){NAN.Game=function(){function e(){var e,t,n;$.backgroundBlockId=0,this.score=new NAN.Score,this.gridId=0,this.init(),this.gridMargin=2,this.containerHeight=670,this.containerWidth=600,this.numGridRows=5,this.numGridColumns=5,this.numGrids=this.numGridColumns*this.numGridRows,this.gridWidth=(this.containerWidth-100)/this.numGridRows,this.gridHeight=this.gridWidth,this.gridXOffset=110,this.gridYOffset=(this.containerWidth-this.numGridColumns*this.gridWidth)/2,setStyleRuleValue(".board","width",""+this.containerWidth+"px"),setStyleRuleValue(".board","height",""+this.containerHeight+"px"),setStyleRuleValue(".number","line-height",""+this.gridHeight+"px"),setStyleRuleValue(".square","height",""+(this.gridHeight-this.gridMargin*2)+"px"),setStyleRuleValue(".square","width",""+(this.gridWidth-this.gridMargin*2)+"px"),this.gameOver=!1,this.grids=[],this.mouse=new NAN.Mouse,this.paused=!0,this.timeLeft=60,this.timeTotal=60,this.gridQueue=[];for(e=t=0,n=this.numGridRows;0<=n?t<n:t>n;e=0<=n?++t:--t)this.grids[e]=[];this.initTouchScreen(),this.startTime=getTime(),this.gridsToShow=[]}return e.prototype.initTouchScreen=function(){var e=this;return $("#container").on("touchstart",function(t){var n;return n=e.getEventGrid(t),n&&n.mouseDown(),!1}),$("#container").on("touchmove",function(t){var n;return n=e.getEventGrid(t),n&&n.mouseOver(),console.log(n),!1}),$("#container").on("touchend",function(t){return e.mouse.endPath(),!1})},e.prototype.getEventPosition=function(e){var t,n;return n=e.originalEvent.targetTouches[0].pageX-$("#container").offset().left,t=e.originalEvent.targetTouches[0].pageY-$("#container").offset().top,{x:t,y:n}},e.prototype.getEventGrid=function(e){var t;return t=this.getEventPosition(e),this.getGridAt(t.x,t.y)},e.prototype.newGrid=function(e,t,n){var r;return n==null&&(n=!0),r=new NAN.Grid(e,t,this,n),this.grids[e][t]=r,this.gridQueue.push(r)},e.prototype.getGridAt=function(e,t){var n,r,i,s;s=this.gridQueue;for(r=0,i=s.length;r<i;r++){n=s[r];if(n.testInside(e,t))return n}return null},e.prototype.init=function(){return this.time=0},e.prototype.movementEnd=function(){var e,t,n,r,i,s,o,u;t=!0,u=this.grids;for(r=0,s=u.length;r<s;r++){n=u[r];for(i=0,o=n.length;i<o;i++)e=n[i],e!==null&&e.deltaX!==0&&(t=!1)}return t},e.prototype.nextFrame=function(){var e,t,n,r,i,s,o,u,a;o=function(){a=[];for(var e=0,t=this.numGridRows;0<=t?e<t:e>t;0<=t?e++:e--)a.push(e);return a}.apply(this).reverse(),u=[];for(n=0,i=o.length;n<i;n++)e=o[n],u.push(function(){var n,r,i;i=[];for(t=n=0,r=this.numGridColumns;0<=r?n<r:n>r;t=0<=r?++n:--n)this.grids[e][t]===null||!this.grids[e][t].exist?e>0&&this.grids[e-1][t]!==null?(this.grids[e-1][t].deltaX+=this.gridHeight,this.grids[e][t]=this.grids[e-1][t],this.grids[e-1][t].moveTo(e,t),i.push(this.grids[e-1][t]=null)):e===0?(this.newGrid(e,t,!1),this.gridsToShow.push(this.grids[e][t]),this.grids[e][t].getElement().hide(),i.push(this.grids[e][t].getElement().css("opacity",0))):i.push(void 0):i.push(void 0);return i}.call(this));return u},e.prototype.updateGrids=function(){var e,t,n,r,i;t=[],i=this.gridQueue;for(n=0,r=i.length;n<r;n++)e=i[n],e===null||e.exist===!1?0:(e.update(),t.push(e));return this.gridQueue=t},e.prototype.getPaused=function(){return this.gameOver?!0:this.time<=60?!0:$.numberShow&&!$.numberShow.finished?!0:this.movementEnd()?!1:!0},e.prototype.update=function(){var e,t,n,r,i,s,o,u;this.paused=this.getPaused();if(this.time<this.numGridRows*5){if(this.time%5===0){t=this.time/5;for(n=r=0,o=this.numGridColumns;0<=o?r<o:r>o;n=0<=o?++r:--r)this.newGrid(t,n)}}else this.nextFrame();if(this.movementEnd()){u=this.gridsToShow;for(i=0,s=u.length;i<s;i++)e=u[i],e.show();this.gridsToShow=[]}return this.updateGrids(),this.score.update(),this.time+=1,$.numberShow&&($.numberShow.update(),$.numberShow.finished&&($.numberShow=null)),this.paused||(this.timeLeft-=.02),this.timeLeft<0&&!this.gameOver&&this.over(),$("#progressbar").attr("value",""+this.timeLeft/this.timeTotal*100)},e.prototype.over=function(){var e,t=this;return e=2e3,$("#game-over-screen").fadeIn(e),this.finalScore=this.score.value,this.score.addValue(-this.finalScore),this.gameOver=!0,this.timeLeft>=0&&$(".score").fadeOut(500),setTimeout(function(){return t.score.addValue(t.finalScore),$(".score").fadeIn(500)},e)},e}(),this.newGame=function(){var e;return $.game=new NAN.Game,$.gameUpdater&&clearInterval($.gameUpdater),e=.7,$(".square").remove(),$("#game-over-screen").hide(),$("#number-show").hide(),$("#number-show").css("opacity","0.0"),$("#how-to-play").slideUp(0),$("#container").animate({top:"+=700px"},0),$("#container").animate({top:"-=700px"},1900*e),setTimeout(function(){return $.gameUpdater=setInterval(function(){return $.game.update()},20)},2e3*e),setTimeout(function(){return $("#title-1").animate({fontSize:"90px"},500*e),$("#title-2").slideUp(500*e),$("#title-3").animate({fontSize:"49px"},500*e)},3e3*e)},this.init=function(){var e=this;return $.mobileMode=mobileMode(),$.mobileMode&&setStyleRuleValue(".square:hover","border-radius","20%"),$.audioPlayerA=new NAN.AudioPlayer("a"),$.audioPlayerB=new NAN.AudioPlayer("b"),$.analyzer=new window.NAN.Analyzer,$.game=new NAN.Game,$("#game-over-hint").click(function(){return newGame()}),$("body").mouseup(function(){return $.game.mouse.endPath()}),$("#welcome-screen").click(function(){return $("#welcome-screen").fadeOut(200),newGame()})},$(document).ready(function(){return init()})}).call(this);